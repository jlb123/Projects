*****************************************************************************************************;
* GHOST TIME BIAS CODE
* ANALYST: JENNY BLASE	
* NOTE: THIS ANALYSIS CAME FROM CHECKING THE PROPORTIONAL HAZARDS ASSUMPTION FOR THE SOCIAL SUPPORT AND MORTALITY ANALYSIS WITH KASSANDRA ALCARAZ AND SUE GAPSTUR
* USE THIS CODE WITH THE FINALCOHORT DATASET FROM THE SOCIAL SUPPORT ANALYSIS AT: S:\USER\JBLASE\Social Support\DATA
* IF YOU CAN'T FIND THE RIGHT OUTPUT IN G:\Epidemiology\Staff\Jenny Blase\Ghost Time Bias\Output and Tables\Output THEN TAKE A LOOK IN S:\USER\JBLASE\Social Support\OUTPUT
*****************************************************************************************************;

LIBNAME SOCIAL 'D:\USER\JBLASE\Social Support\DATA';
LIBNAME LIBRARY 'D:\USER\JBLASE\Social Support\DATA';

*ONCE WE REALIZED THE PROPORTIONAL HAZARDS ASSUMPTION WAS VIOLATED WE STARTED DOWN THIS ROAD...;
*END OF FOLLOW UP FOR THIS ANALYSIS - 12,31,2012*;
*WHEN BOTH WALD AND LR TEST ARE SIGNIFICANT SPLIT FOLLOW UP TIME INTO DIFFERENT TIME PERIODS TO SEE WHETHER RR'S DIFFER BETWEEN THEM *;

*SPLIT ANALYSES INTO 3 DIFFERENT PERIODS (ONLY NEED 3 PER RYAN DIVER) AND SEE WHETHER RR'S DIFFER OVER THOSE PERIODS - 30 YEAR FU SO WILL SPLIT INTO 10/10/11 YEAR PERIODS*;
*IF PEOPLE NOT IN TIME PERIOD THEN SET TO MISSING SO ANALYSIS WILL DROP THEM*;
*1ST TIME PERIOD: 1982-12/31/1991, 2ND TIME PERIOD: 1/1/1992-12/31/2001, 3RD TIME PERIOD: 1/1/2002-12/31-2012*; 
*CODE BELOW CENSORED ON 3 DIFFERENT VALUES: 90 FOR EVERYONE, 95 FOR EVERYONE AND 90 IF DIDN'T HAVE A SSN/95 IF HAD A SSN*;

DATA SPLIT;
SET SOCIAL.FINALCOHORT;

*CODE FOR CENSORING AT 90*;
IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+32872.5));
ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+32872.5));

*CODE FOR CENSORING AT 95*;
/*IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+34698.75));*/
/*ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+34698.75));*/

*DIFFERENTIAL CENSORING BY SSN*;
/*IF SSN_1982='Y' THEN DO; *IF THEY HAVE A SSN, CENSORING AT 95*;*/
/*	IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+34698.75));*/
/*	ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+34698.75));*/
/*END;*/
/**/
/*ELSE IF SSN_1982='N' THEN DO; *IF THEY DON'T HAVE A SSN, CENSORING AT 90*;*/
/*	IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+32872.5));*/
/*	ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+32872.5));*/
/*END;*/

FAILNEW=DATEFU-BEGDATE;
FAILNEW_MO=(FAILNEW/365.25 + 1/365.25)*12; *CREATING FAIL TIME IN MONTHS SO CODE WILL RUN FASTER*;
IF DATEFU<DTHDATE THEN ALLCAUSE=0; *IF SOMEONE TURNED 90 OR 95 BEFORE THEY DIED, SETTING DEATH TO 0*;

BEG2B=.; BEG3B=.; ENDDATE=MDY(12,31,2012);
END1B=MDY(12,31,1991); END2B=MDY(12,31,2001);
DATEDD1B=DATEFU; DATEDD2B=DATEFU; DATEDD3B=DATEFU; 

IF DATEFU > END1B THEN DO; DATEDD1B=END1B; BEG2B=MDY(1,1,1992); END;                             
IF DATEFU > END2B THEN DO; DATEDD2B=END2B; BEG3B=MDY(1,1,2002); END; 
IF DATEFU > ENDDATE THEN DATEDD3B=ENDDATE;                        
   
FAIL1B = (DATEDD1B-BEGDATE)/365.25 + 1/365.25; *IN YEARS*;                 
IF DATEDD2B > END1B THEN FAIL2B = (DATEDD2B - END1B)/365.25;          
IF DATEDD3B > END2B THEN FAIL3B = (DATEDD3B - END2B)/365.25; 

*ADDING IN ATTAINED AGE VARIABLES*;
BEGAGE82=BEGDATE-BDAYDATE;
BEGAGE82_YRS=BEGAGE82/365.25+1/365.25; *IN YEARS*;

*CONVERTING FAIL TIME IN YEARS TO MONTHS SO MODELS WILL RUN FASTER*;
FAIL1B_MO=INT(FAIL1B*12);
FAIL2B_MO=INT(FAIL2B*12);
FAIL3B_MO=INT(FAIL3B*12);

IF FAIL1B_MO=0 THEN FAIL1B_MO=0.5;
IF FAIL2B_MO=0 THEN FAIL2B_MO=0.5;
IF FAIL3B_MO=0 THEN FAIL3B_MO=0.5;

*** CENSORING VARIABLES FOR EACH FAIL TIME - THE ORDER IS IMPORTANT;
*** DEATH FROM ANY CAUSE;
CORE1B=0; CORE2B=0; CORE3B=0;         
SELECT (ALLCAUSE);                          
  WHEN (1) DO;                        
    IF FAIL3B NE . THEN CORE3B=1;        
    ELSE IF FAIL2B NE . THEN CORE2B=1;        
    ELSE IF FAIL1B NE . THEN CORE1B=1;        
  END;                                      
  OTHERWISE;                                
END; 
RUN;


/*DATA SPLITSSN;*/
/*SET SPLIT;*/
/**/
/*IF SSN_1982='Y' AND AGE_INT GE 95 THEN DELETE; *DELETING EVERYONE 95 AND OLDER AT BASELINE WTIH A SSN*;*/
/*ELSE IF SSN_1982='N' AND AGE_INT GE 90 THEN DELETE; *DELETING EVERYONE 90 AND OLDER AT BASELINE WTIHOUT A SSN*;*/
/**/
/*RUN;*/

DATA SPLIT90;
SET SPLIT;

IF AGE_INT GE 90 THEN DELETE; *DELETING EVERYONE 90 AND OLDER AT BASELINE*;

RUN;


*SPLITTING DATASET AND DELETING PEOPLE WHO DID NOT HAVE A SSN AT BASELINE*;
DATA SPLIT_SSN;
MERGE SOCIAL.FINALCOHORT (IN=INSOCIAL);
BY ID;
IF INSOCIAL;

IF SSN_1982='N' THEN DELETE; *REMOVING PEOPLE WHO DID NOT HAVE A SSN IN 1982*;

BEG2B=.; BEG3B=.; ENDDATE=MDY(12,31,2012);
END1B=MDY(12,31,1991); END2B=MDY(12,31,2001);
DATEDD1B=DATEDD; DATEDD2B=DATEDD; DATEDD3B=DATEDD; 

IF DATEDD > END1B THEN DO; DATEDD1B=END1B; BEG2B=MDY(1,1,1992); END;                             
IF DATEDD > END2B THEN DO; DATEDD2B=END2B; BEG3B=MDY(1,1,2002); END; 
IF DATEDD > ENDDATE THEN DATEDD3B=ENDDATE;                        
   
FAIL1B = (DATEDD1B-BEGDATE)/365.25 + 1/365.25; *IN YEARS*;                 
IF DATEDD2B > END1B THEN FAIL2B = (DATEDD2B - END1B)/365.25;          
IF DATEDD3B > END2B THEN FAIL3B = (DATEDD3B - END2B)/365.25; 

*ADDING IN ATTAINED AGE VARIABLES*;
BEGAGE82=BEGDATE-BDAYDATE;
BEGAGE82_YRS=BEGAGE82/365.25+1/365.25; *IN YEARS*;

*CONVERTING FAIL TIME IN YEARS TO MONTHS SO MODELS WILL RUN FASTER*;
FAIL1B_MO=INT(FAIL1B*12);
FAIL2B_MO=INT(FAIL2B*12);
FAIL3B_MO=INT(FAIL3B*12);

IF FAIL1B_MO=0 THEN FAIL1B_MO=0.5;
IF FAIL2B_MO=0 THEN FAIL2B_MO=0.5;
IF FAIL3B_MO=0 THEN FAIL3B_MO=0.5;

*** CENSORING VARIABLES FOR EACH FAIL TIME - THE ORDER IS IMPORTANT;
*** DEATH FROM ANY CAUSE;
CORE1B=0; CORE2B=0; CORE3B=0;         
SELECT (ALLCAUSE);                          
  WHEN (1) DO;                        
    IF FAIL3B NE . THEN CORE3B=1;        
    ELSE IF FAIL2B NE . THEN CORE2B=1;        
    ELSE IF FAIL1B NE . THEN CORE1B=1;        
  END;                                      
  OTHERWISE;                                
END; 

RUN;

***3 FOLLOW-UP PERIODS;
DATA FIRST;                         
SET SPLITSSN; 
RUN; 

DATA SECOND;
SET SPLITSSN; 
IF BEG2B NE .  ;
RUN; 

DATA THIRD;
SET SPLITSSN; 
IF BEG3B NE .;
RUN; 



***COX MULTIVARIATE MODELS
DATSET=  - DATASET
FT – PERIOD SPECIFIC FAIL TIME VARIABLE
CSOR – EVENT/OUTCOME
COND – USE WHERE STATEMENT IF NEEDED TO RESTRICT
POP – FOR TITLE2
*;

%MACRO COX (DATSET=,FT=,CSOR=,COND=,POP=);
      PROC PHREG DATA=&DATSET;    
	  CLASS BSINDEX/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX/RL; 
 
 
      STRATA AGE_INT; 
      WHERE &COND;   
      TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                    
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'AGE-ADJUSTED MODEL';                                                       
      RUN;  

      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL; 
      STRATA AGE_INT; 
      WHERE &COND;   
      TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';                                                       
      RUN;  

%MEND COX;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS - &SYSDATE..RTF";
%COX (DATSET=FIRST,FT=FAIL1B,CSOR=CORE1B,COND=FAIL1B NE .,POP=FIRST PERIOD)
%COX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE .,POP=SECOND PERIOD)
%COX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE .,POP=THIRD PERIOD);
ODS RTF CLOSE;

****************************************;
*ATTAINED AGE STRATIFIED BY TIME PERIOD*;
****************************************;
*SENT FROM CHRISSY IN AN EMAIL ON 10/8/15*;

*************************;
* BY ATTAINED AGE       *;
*************************;

/*DATA ATTAGE; SET SOCIAL.FINALCOHORT;*/
/*      BEGAGE82=DTINT82-BDAYDATE;*/
/*      BEGAGE82_YRS=BEGAGE82/365.25+1/365.25; */
/*RUN;*/


*ATTAINED AGE MODEL IN ENTIRE COHORT*;

      ***<75**************;
/*      PROC PHREG DATA=ATTAGE MULTIPASS;*/
/*      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;*/
/*      MODEL FAIL*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL;*/
/*            AGENOW=BEGAGE82_YRS + FAIL - 1/365.25;*/
/*           IF AGENOW<75 THEN LT75=1;*/
/*            STRATA AGE_INT;*/
/*            TITLE2 'ATTAINED AGE <75';*/
/*      RUN;*/

*IN THIS METHOD I WILL NOT GET AN EFFECT ESTIMATE FOR LT75 BECAUSE IT IS DROPPING ALL STRATA THAT ARE MISSING (THEREFORE INCLUDING ONLY OBS THAT ARE LESS THAN 75 YEARS OLD*;

*<75 IN MONTHS*;
	  ODS OUTPUT PARAMETERESTIMATES=UNDER75;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
           IF AGENOW<75 THEN LT75=1;
            STRATA AGE_INT;
            TITLE2 'ATTAINED AGE <75';
      RUN;
	  ODS OUTPUT CLOSE;

      ***75+**************;
	  ODS OUTPUT PARAMETERESTIMATES=OVER75;
      PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK GE75/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
           IF AGENOW>=75 THEN GE75=1;
            STRATA AGE_INT;
            TITLE2 'ATTAINED AGE 75+';
      RUN;
	ODS OUTPUT CLOSE;


DATA SOCIAL.UNDER75_ALLYEARS;
SET UNDER75;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;


DATA OVER75_ALLYEARS;
SET SOCIAL.OVER75;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK ATTAINED AGE NON-STRATIFIED MODELS - &SYSDATE..RTF";

TITLE '1982-2012, UNDER 75 YEARS'; PROC PRINT DATA=SOCIAL.UNDER75_ALLYEARS; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, 75+ YEARS'; PROC PRINT DATA=OVER75_ALLYEARS; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*ATTAINED AGE STRATIFIED BY TIME PERIOD*; 
 
***COX MULTIVARIATE MODELS
DATSET=  - DATASET
FT – PERIOD SPECIFIC FAIL TIME VARIABLE
CSOR – EVENT/OUTCOME
COND – USE WHERE STATEMENT IF NEEDED TO RESTRICT
POP – FOR TITLE2
*;

	PROC PHREG DATA=ATTAGE MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
           IF AGENOW<75 THEN LT75=1;
            STRATA AGE_INT;
            TITLE2 'ATTAINED AGE <75';
      RUN;

OPTIONS MPRINT;	  

*CORRECT MACRO FOR LESS THAN 75 - USE THIS*;

*REMOVED THE AGE ADJUSTED ONLY MODEL THAT WAS THE TOP PART OF JANET'S COX MACRO BELOW SINCE WE ONLY NEED MULTIVARIATE ADJUSTED*;
%MACRO COX (DATSET=,FT=,CSOR=,COND=,POP=,FLPERIODS=);
	  ODS OUTPUT PARAMETERESTIMATES=&DATSET._UNDER75;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL; 
	  AGENOW=BEGAGE82_YRS + ((&FLPERIODS)/12) - 1/365.25;
      IF AGENOW<75 THEN LT75=1;
	  STRATA AGE_INT; 
      WHERE &COND;   

	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';  
	  TITLE7 '<75 YEARS OLD'; 
      RUN;  
	  ODS OUTPUT CLOSE;

	  DATA &DATSET._UNDER75_NEW;
		SET &DATSET._UNDER75;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");
RUN;


%MEND COX;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS UNDER 75 YEARS - &SYSDATE..RTF";
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO)
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO)
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO);
ODS RTF CLOSE;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS UNDER 75 YEARS RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_UNDER75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_UNDER75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_UNDER75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;



*JENNY - USE THIS AS AN EXAMPLE FOR MACRO WITH MONTHS*;
PROC PHREG DATA=first;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL FAIL1B_MO * CORE1B(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL; 
	  AGENOW=(BEGAGE82_YRS + FAIL1B_MO/12) - 1/365.25;
      IF AGENOW<75 THEN LT75=1;
	  STRATA AGE_INT; 
      WHERE FAIL1B_MO NE .;   
RUN;

*EXAMPLE USING YEARS VARIABLE*;
PROC PHREG DATA=first;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL FAIL1B * CORE1B(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL; 
	  AGENOW=BEGAGE82_YRS + FAIL1B - 1/365.25;
      IF AGENOW<75 THEN LT75=1;
	  STRATA AGE_INT; 
      WHERE FAIL1B NE .;   
RUN;



*CODE WITH CHRISSY'S FIX. USE THIS ONE!*;

/* ODS OUTPUT PARAMETERESTIMATES=FIRST_UNDER75;*/
/*      PROC PHREG DATA=FIRST;*/
/*	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; */
/*      MODEL FAIL1B * CORE1B(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL; */
/*	  AGENOW=BEGAGE82_YRS + FAIL1B - 1/365.25;*/
/*      IF AGENOW<75 THEN LT75=1;*/
/*	  STRATA AGE_INT; */
/*      WHERE FAIL1B NE .;   */
/**/
/*	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           */
/*      TITLE2 "POPULATION: FIRST TIME PERIOD";                  */
/*      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             */
/*      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       */
/*      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           */
/*      TITLE6 'MULTIVARIATE MODEL';  */
/*	  TITLE7 '<75 YEARS OLD'; */
/*      RUN;  */
/*	  ODS OUTPUT CLOSE;*/
/**/
/**/
/**/
/* ODS OUTPUT PARAMETERESTIMATES=SECOND_UNDER75;*/
/*	  PROC PHREG DATA=SECOND;*/
/*	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; */
/*      MODEL FAIL2B * CORE2B(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL; */
/*	  AGENOW=BEGAGE82_YRS + (FAIL2B+FAIL1B) - 1/365.25;*/
/*      IF AGENOW<75 THEN LT75=1;*/
/*	  STRATA AGE_INT; */
/*      WHERE FAIL2B NE .;   */
/**/
/*	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           */
/*      TITLE2 "POPULATION: SECOND TIME PERIOD";                  */
/*      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             */
/*      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       */
/*      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           */
/*      TITLE6 'MULTIVARIATE MODEL';  */
/*	  TITLE7 '<75 YEARS OLD'; */
/*      RUN;  */
/*ODS OUTPUT CLOSE;*/
/**/
/**/
/*ODS OUTPUT PARAMETERESTIMATES=THIRD_UNDER75;*/
/*PROC PHREG DATA=THIRD;*/
/*	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; */
/*      MODEL FAIL3B * CORE3B(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT75/RL; */
/*	  AGENOW=BEGAGE82_YRS + (FAIL3B+FAIL2B+FAIL1B) - 1/365.25;*/
/*      IF AGENOW<75 THEN LT75=1;*/
/*	  STRATA AGE_INT; */
/*      WHERE FAIL3B NE .;   */
/**/
/*	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           */
/*      TITLE2 "POPULATION: THIRD TIME PERIOD";                  */
/*      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             */
/*      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       */
/*      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           */
/*      TITLE6 'MULTIVARIATE MODEL';  */
/*	  TITLE7 '<75 YEARS OLD'; */
/*      RUN;  */
/*ODS OUTPUT CLOSE;*/


*JENNY - USE THIS ONE. RUN IT!*;
*MACRO FOR 75+ STRATIFIED BY 10 YEAR FOLLOW UP PERIODS*;

%MACRO COX2 (DATSET=,FT=,CSOR=,COND=,POP=,FLPERIODS=);
	  ODS OUTPUT PARAMETERESTIMATES=&DATSET._OVER75;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK GE75/RL; 
	  AGENOW=BEGAGE82_YRS + ((&FLPERIODS)/12) - 1/365.25;
      IF AGENOW GE 75 THEN GE75=1;
	  STRATA AGE_INT; 
      WHERE &COND;   

	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';  
	  TITLE7 '75+ YEARS OLD'; 
      RUN;  
	  ODS OUTPUT CLOSE;

	 
	  DATA &DATSET._OVER75_NEW;
		SET &DATSET._OVER75;

		IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");
RUN;


%MEND COX2;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS OVER 75 YEARS - &SYSDATE..RTF";
%COX2 (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO)
%COX2 (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO)
%COX2 (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO);
ODS RTF CLOSE;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS OVER 75 YEARS RRCI - &SYSDATE..RTF";
TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_OVER75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_OVER75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_OVER75_NEW; VAR ClassVal0 RR CI; RUN;
ODS RTF CLOSE;


*CUSTOMIZABLE MACRO FOR ATTAINED AGE STRATIFIED BY FU PERIOD*;

*AGEDESC = DESCRIPTION OF AGE GROUP (MUST BE ONE WORD, CAN'T START WITH SYMBOLS)*;
*AGEGRP = DIVIDES OUT THE AGE GROUPS, CAN USE SYMBOLS*;

%MACRO COX (DATSET=,FT=,CSOR=,COND=,POP=,FLPERIODS=,AGEDESC=,AGEGRP=);
	  ODS OUTPUT PARAMETERESTIMATES=&DATSET._&AGEDESC;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK &AGEDESC/RL; 
	  AGENOW=BEGAGE82_YRS + ((&FLPERIODS)/12) - 1/365.25;
      IF %STR(&AGEGRP) THEN &AGEDESC=1;
	  STRATA AGE_INT; 
      WHERE &COND;   

	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';  
	  TITLE7 "AGE GROUP: &AGEDESC"; 
      RUN;  
	  ODS OUTPUT CLOSE;

	  DATA &DATSET._&AGEDESC._NEW;
		SET &DATSET._&AGEDESC;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");
RUN;


%MEND COX;

*MODELS IN <70 ATTAINED AGE GROUP*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=LT70, AGEGRP=AGENOW<70)
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=LT70, AGEGRP=AGENOW<70)
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=LT70, AGEGRP=AGENOW<70);

TITLE1; TITLE2; TITLE3; TITLE4; TITLE5; TITLE6; TITLE7;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS UNDER 70 YEARS RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA= FIRST_LT70_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_LT70_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_LT70_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*MODELS IN 70-79 ATTAINED AGE GROUP*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=BW70_79, AGEGRP=(AGENOW GE 70 AND AGENOW LT 80))
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=BW70_79, AGEGRP=(AGENOW GE 70 AND AGENOW LT 80))
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=BW70_79, AGEGRP=(AGENOW GE 70 AND AGENOW LT 80));

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 70-79 YEARS RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_BW70_79_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_BW70_79_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_BW70_79_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*MODELS IN 80+ ATTAINED AGE GROUP*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=GE80, AGEGRP= (AGENOW GE 80))
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=GE80, AGEGRP= (AGENOW GE 80))
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=GE80, AGEGRP= (AGENOW GE 80));

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 80+ YEARS RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA= FIRST_GE80_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_GE80_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_GE80_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*ATTAINED AGE MODELS IN ENTIRE COHORT (NOT STRATIFIED BY FOLLOW UP TIME)*;

	*<70 IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=LT70_ALL;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT70/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
           IF AGENOW<70 THEN LT70=1;
            STRATA AGE_INT;
            TITLE2 'ATTAINED AGE <70';
			TITLE3 'POPULATION: ENTIRE COHORT';
      RUN;
	  ODS OUTPUT CLOSE;

DATA LT70_ALL_NEW;
SET LT70_ALL;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;


      ***70-79**************;
	  ODS OUTPUT PARAMETERESTIMATES=BW70_79_ALL;
      PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK BW70_79/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
           IF (AGENOW GE 70 AND AGENOW LT 80) THEN BW70_79=1;
            STRATA AGE_INT;
            TITLE2 'ATTAINED AGE 70-79';
			TITLE3 'POPULATION: ENTIRE COHORT';
      RUN;
	ODS OUTPUT CLOSE;


DATA BW70_79_ALL_NEW;
SET BW70_79_ALL;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;



***80+**************;
	  ODS OUTPUT PARAMETERESTIMATES=GE80_ALL;
      PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK GE80/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF (AGENOW GE 80) THEN GE80=1;
            STRATA AGE_INT;
            TITLE2 'ATTAINED AGE 80+';
			TITLE3 'POPULATION: ENTIRE COHORT';
      RUN;
	ODS OUTPUT CLOSE;


DATA GE80_ALL_NEW;
SET GE80_ALL;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

TITLE2; TITLE3;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY ATTAINED AGE NON-STRATIFIED MODELS - &SYSDATE..RTF";

TITLE '1982-2012, UNDER 70 YEARS'; PROC PRINT DATA=LT70_ALL_NEW; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, 70-79 YEARS'; PROC PRINT DATA=BW70_79_ALL_NEW; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, 80+ YEARS'; PROC PRINT DATA=GE80_ALL_NEW; VAR ClassVal0 RR CI; RUN;


ODS RTF CLOSE;

options mprint;

*MODELS STRATIFIED BY FOLLOW UP TIME AND AGE AT BASELINE*;

***COX MULTIVARIATE MODELS
DATSET=  - DATASET
FT – PERIOD SPECIFIC FAIL TIME VARIABLE
CSOR – EVENT/OUTCOME
COND – USE WHERE STATEMENT IF NEEDED TO RESTRICT
POP – FOR TITLE2
*;

%MACRO COX (DATSET=,FT=,CSOR=,COND=,POP=, AGEDESC=);
ODS OUTPUT PARAMETERESTIMATES=&DATSET._&AGEDESC;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL; 
      STRATA AGE_INT; 
      WHERE &COND;   
      TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';                                                       
      RUN;  

DATA &DATSET._&AGEDESC._NEW;
		SET &DATSET._&AGEDESC;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");
RUN;


ODS OUTPUT CrossTabFreqs=&DATSET._&AGEDESC._FREQ;
PROC FREQ DATA=&DATSET;
     TABLES BSINDEX*&CSOR/NOROW NOCOL NOPERCENT NOCUM;
     WHERE &COND;
RUN;
ODS OUTPUT CLOSE;

DATA &DATSET._&AGEDESC._FREQN;
SET &DATSET._&AGEDESC._FREQ;

IF &CSOR=1;

RUN;

%MEND COX;

*LESS THAN 65 YEARS AT BASELINE*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, AGEDESC=LT65)
%COX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT LT 65,POP=SECOND PERIOD, AGEDESC=LT65)
%COX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT LT 65,POP=THIRD PERIOD, AGEDESC=LT65);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS LT 65 YEARS AT BL RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA= FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*BETWEEN 65-74 YEARS AT BASELINE*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, AGEDESC=BW65_74)
%COX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, AGEDESC=BW65_74)
%COX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, AGEDESC=BW65_74);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 65-74 YEARS AT BL RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA= FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*75+ YEARS AT BASELINE*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, AGEDESC=GE75)
%COX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT GE 75,POP=SECOND PERIOD, AGEDESC=GE75)
%COX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT GE 75,POP=THIRD PERIOD, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 75+ YEARS AT BL RRCI - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA= FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD'; PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*AGE AT BASELINE MODELS IN ENTIRE COHORT (NOT STRATIFIED BY FOLLOW UP TIME)*;

	*<65 IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=LT65_ALL;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL;
            WHERE AGE_INT LT 65;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE <65';
			TITLE3 'POPULATION: ENTIRE COHORT';
      RUN;
	  ODS OUTPUT CLOSE;

DATA LT65_ALL_NEW;
SET LT65_ALL;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;


*65-74 YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=BW65_74_ALL;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL;
            WHERE AGE_INT GE 65 AND AGE_INT LT 75;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 65-74';
			TITLE3 'POPULATION: ENTIRE COHORT';
      RUN;
	  ODS OUTPUT CLOSE;

DATA BW65_74_ALL_NEW;
SET BW65_74_ALL;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;


*75+ YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=GE75_ALL;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL;
            WHERE AGE_INT GE 75;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 75+';
			TITLE3 'POPULATION: ENTIRE COHORT';
      RUN;
	  ODS OUTPUT CLOSE;

DATA GE75_ALL_NEW;
SET GE75_ALL;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY AGE AT BL MODELS - &SYSDATE..RTF";

TITLE '1982-2012, UNDER 65 YEARS'; PROC PRINT DATA=LT65_ALL_NEW; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, 65-74 YEARS'; PROC PRINT DATA=BW65_74_ALL_NEW; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, 75+ YEARS'; PROC PRINT DATA=GE75_ALL_NEW; VAR ClassVal0 RR CI; RUN;


ODS RTF CLOSE;

******************************************************;
*AGE AT BASELINE STRATIFIED BY SEX AND FOLLOW-UP TIME*;
******************************************************;

***COX MULTIVARIATE MODELS
DATSET=  - DATASET
FT – PERIOD SPECIFIC FAIL TIME VARIABLE
CSOR – EVENT/OUTCOME
COND – USE WHERE STATEMENT IF NEEDED TO RESTRICT
POP – FOR TITLE2
*;

%MACRO COX_SEX (DATSET=,FT=,CSOR=,COND=,POP=, AGEDESC=,COV=);
ODS OUTPUT PARAMETERESTIMATES=&DATSET._&AGEDESC;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK &COV/RL; 
      STRATA AGE_INT; 
      WHERE &COND;   
      TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';                                                       
      RUN;  

DATA &DATSET._&AGEDESC._NEW;
		SET &DATSET._&AGEDESC;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;


ODS OUTPUT CrossTabFreqs=&DATSET._&AGEDESC._FREQ;
PROC FREQ DATA=&DATSET;
     TABLES BSINDEX*&CSOR/NOROW NOCOL NOPERCENT NOCUM;
     WHERE &COND;
RUN;
ODS OUTPUT CLOSE;

DATA &DATSET._&AGEDESC._FREQN;
SET &DATSET._&AGEDESC._FREQ;

IF &CSOR=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;

%MEND COX_SEX;



*********;
*FEMALES*;
*********;

*LESS THAN 65 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65 AND SEX=1,POP=FIRST PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT LT 65 AND SEX=1,POP=SECOND PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT LT 65 AND SEX=1,POP=THIRD PERIOD, AGEDESC=LT65);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS LT 65 YEARS AT BL FEMALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*BETWEEN 65-74 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=1,POP=FIRST PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=1,POP=SECOND PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=1,POP=THIRD PERIOD, AGEDESC=BW65_74);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 65-74 YEARS AT BL FEMALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*75+ YEARS AT BASELINE*;
%COX_SEX  (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75 AND SEX=1,POP=FIRST PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT GE 75 AND SEX=1,POP=SECOND PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT GE 75 AND SEX=1,POP=THIRD PERIOD, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 75+ YEARS AT BL FEMALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*AGE AT BASELINE MODELS IN FEMALES (NOT STRATIFIED BY FOLLOW UP TIME)*;

	*<65 IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=LT65_ALL_F;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT LT 65 AND SEX=1;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE <65';
			TITLE3 'POPULATION: FEMALES ONLY';
      RUN;
	  ODS OUTPUT CLOSE;

DATA LT65_ALL_NEW_F;
SET LT65_ALL_F;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=LT65_ALL_FREQ;
PROC FREQ DATA=SPLIT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1 AND AGE_INT LT 65;
RUN;
ODS OUTPUT CLOSE;


*65-74 YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=BW65_74_ALL_F;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 65 AND AGE_INT LT 75 AND SEX=1;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 65-74';
			TITLE3 'POPULATION: FEMALES ONLY';
      RUN;
	  ODS OUTPUT CLOSE;

DATA BW65_74_ALL_NEW_F;
SET BW65_74_ALL_F;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=BW65_74_ALL_FREQ;
PROC FREQ DATA=SPLIT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1 AND AGE_INT GE 65 AND AGE_INT LT 75;
RUN;
ODS OUTPUT CLOSE;


*75+ YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=GE75_ALL_F;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 75 AND SEX=1;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 75+';
			TITLE3 'POPULATION: FEMALES ONLY';
      RUN;
	  ODS OUTPUT CLOSE;

DATA GE75_ALL_NEW_F;
SET GE75_ALL_F;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=GE75_ALL_FREQ;
PROC FREQ DATA=SPLIT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1 AND AGE_INT GE 75;
RUN;
ODS OUTPUT CLOSE;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY AGE AT BL MODELS FEMALES - &SYSDATE..RTF";

TITLE '1982-2012, FEMALES UNDER 65 YEARS'; PROC PRINT DATA=LT65_ALL_FREQ; RUN; PROC PRINT DATA=LT65_ALL_NEW_F; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, FEMALES 65-74 YEARS'; PROC PRINT DATA=BW65_74_ALL_FREQ; RUN; PROC PRINT DATA=BW65_74_ALL_NEW_F; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, FEMALES 75+ YEARS'; PROC PRINT DATA=GE75_ALL_FREQ; RUN; PROC PRINT DATA=GE75_ALL_NEW_F; VAR ClassVal0 RR CI; RUN;


ODS RTF CLOSE;

*MODELS NOT STRATIFIED BY AGE AT BASELINE BUT STRATIFIED BY FU PERIOD*;

%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND SEX=1,POP=FIRST PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND SEX=1,POP=SECOND PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND SEX=1,POP=THIRD PERIOD, AGEDESC=ALLAGE);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS ALL AGES AT BL FEMALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_ALLAGE_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_ALLAGE_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_ALLAGE_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*ALL FEMALES - NOT STRATIFIED BY FU TIME OR AGE AT BL*;

PROC PHREG DATA=SOCIAL.FINALCOHORT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_FEMALES;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE SEX=1;
            STRATA AGE_INT;
            TITLE2 'POPULATION: FEMALES ONLY';
      RUN;
ODS OUTPUT CLOSE;

DATA ALL_FEMALES_NEW;
SET ALL_FEMALES;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=ALL_FEMALES_FREQ;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1;
RUN;
ODS OUTPUT CLOSE;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK FEMALES NON-STRATIFIED - &SYSDATE..RTF";

TITLE 'FEMALES, ALL AGES AND TIME PERIODS'; PROC PRINT DATA=ALL_FEMALES_FREQ; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA=ALL_FEMALES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*******;
*MALES*;
*******;


*LESS THAN 65 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65 AND SEX=0,POP=FIRST PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT LT 65 AND SEX=0,POP=SECOND PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT LT 65 AND SEX=0,POP=THIRD PERIOD, AGEDESC=LT65);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS LT 65 YEARS AT BL MALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*BETWEEN 65-74 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=0,POP=FIRST PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=0,POP=SECOND PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=0,POP=THIRD PERIOD, AGEDESC=BW65_74);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 65-74 YEARS AT BL MALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*75+ YEARS AT BASELINE*;
%COX_SEX  (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75 AND SEX=0,POP=FIRST PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT GE 75 AND SEX=0,POP=SECOND PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT GE 75 AND SEX=0,POP=THIRD PERIOD, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 75+ YEARS AT BL MALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD';PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*AGE AT BASELINE MODELS IN MALES (NOT STRATIFIED BY FOLLOW UP TIME)*;

	*<65 IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=LT65_ALL_M;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT LT 65 AND SEX=0;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE <65';
			TITLE3 'POPULATION: MALES ONLY';
      RUN;
	  ODS OUTPUT CLOSE;

DATA LT65_ALL_NEW_M;
SET LT65_ALL_M;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=LT65_ALL_FREQ;
PROC FREQ DATA=SPLIT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1 AND AGE_INT LT 65;
RUN;
ODS OUTPUT CLOSE;


*65-74 YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=BW65_74_ALL_M;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 65 AND AGE_INT LT 75 AND SEX=0;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 65-74';
			TITLE3 'POPULATION: MALES ONLY';
      RUN;
	  ODS OUTPUT CLOSE;

DATA BW65_74_ALL_NEW_M;
SET BW65_74_ALL_M;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=BW65_74_ALL_FREQ;
PROC FREQ DATA=SPLIT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1 AND AGE_INT GE 65 AND AGE_INT LT 75;
RUN;
ODS OUTPUT CLOSE;


*75+ YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=GE75_ALL_M;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 75 AND SEX=0;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 75+';
			TITLE3 'POPULATION: MALES ONLY';
      RUN;
	  ODS OUTPUT CLOSE;

DATA GE75_ALL_NEW_M;
SET GE75_ALL_M;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=GE75_ALL_FREQ;
PROC FREQ DATA=SPLIT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1 AND AGE_INT GE 75;
RUN;
ODS OUTPUT CLOSE;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY AGE AT BL MODELS MALES - &SYSDATE..RTF";

TITLE '1982-2012, MALES UNDER 65 YEARS'; PROC PRINT DATA=LT65_ALL_FREQ; RUN; PROC PRINT DATA=LT65_ALL_NEW_M; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, MALES 65-74 YEARS'; PROC PRINT DATA=BW65_74_ALL_FREQ; RUN; PROC PRINT DATA=BW65_74_ALL_NEW_M; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, MALES 75+ YEARS'; PROC PRINT DATA=GE75_ALL_FREQ; RUN; PROC PRINT DATA=GE75_ALL_NEW_M; VAR ClassVal0 RR CI; RUN;


ODS RTF CLOSE;

*MODELS NOT STRATIFIED BY AGE AT BASELINE BUT STRATIFIED BY FU PERIOD*;

%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND SEX=0,POP=FIRST PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND SEX=0,POP=SECOND PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND SEX=0,POP=THIRD PERIOD, AGEDESC=ALLAGE);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS ALL AGES AT BL MALES - &SYSDATE..RTF";

TITLE 'FIRST PERIOD, MALES ALL AGES'; PROC PRINT DATA=FIRST_ALLAGE_FREQN; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA= FIRST_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, MALES ALL AGES';PROC PRINT DATA=SECOND_ALLAGE_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=SECOND_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, MALES ALL AGES'; PROC PRINT DATA=THIRD_ALLAGE_FREQN; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=THIRD_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


TITLE; TITLE2; TITLE3;

*ALL MALES - NOT STRATIFIED BY FU TIME OR AGE AT BL*;

PROC PHREG DATA=SOCIAL.FINALCOHORT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_MALES;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE SEX=0;
            STRATA AGE_INT;
            TITLE2 'POPULATION: MALES ONLY';
      RUN;
ODS OUTPUT CLOSE;

DATA ALL_MALES_NEW;
SET ALL_MALES;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=ALL_MALES_FREQ;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1;
RUN;
ODS OUTPUT CLOSE;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK MALES NON-STRATIFIED - &SYSDATE..RTF";

TITLE 'MALES, ALL AGES AND TIME PERIODS'; PROC PRINT DATA=ALL_MALES_FREQ; VAR BSINDEX FREQUENCY; RUN;  PROC PRINT DATA=ALL_MALES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*MERGING IN DATASET WITH INDICATOR FOR SSN (Y/N)*;

DATA SSN;
MERGE SOCIAL.FINALCOHORT (IN=INSOCIAL)
	  MASTER.cps2smgmst15_ssn;
BY ID;
IF INSOCIAL;

*IF SSN_1982='N' THEN DELETE; *REMOVING PEOPLE WHO DID NOT HAVE A SSN IN 1982*;

RUN;


DATA SSN_BLKM SSN_BLKF SSN_WHTM SSN_WHTF;
SET SSN;

IF SEX=0 AND BLACK=1 THEN OUTPUT SSN_BLKM;
ELSE IF SEX=1 AND BLACK=1 THEN OUTPUT SSN_BLKF;
ELSE IF SEX=0 AND WHITE=1 THEN OUTPUT SSN_WHTM;
ELSE IF SEX=1 AND WHITE=1 THEN OUTPUT SSN_WHTF;

RUN;

 
*DISTRIBUTION OF PEOPLE WITH SSN'S IN RACE/SEX GROUPS*;

%INCLUDE 'D:\USER\JBLASE\Macros\DESCRIPTIVE_TBL.sas';
OPTIONS MPRINT;

*BLACK MALES*;
%DESCRIPTIVE_TBL (DAT=SSN_BLKM, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=1,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - BLACK MALES,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - BLACK MALES EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*BLACK FEMALES*;
%DESCRIPTIVE_TBL (DAT=SSN_BLKF, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=1,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - BLACK FEMALES,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - BLACK FEMALES EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*WHITE MALES*;
%DESCRIPTIVE_TBL (DAT=SSN_WHTM, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=1,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - WHITE MALES,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - WHITE MALES EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*WHITE FEMALES*;
%DESCRIPTIVE_TBL (DAT=SSN_WHTF, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=1,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - WHITE FEMALES,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - WHITE FEMALES EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*WOMEN*;

*UNDER 65*;
%DESCRIPTIVE_TBL (DAT=SSN, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=SEX=1 AND AGE_INT LT 65,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - FEMALES UNDER 65,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - FEMALES UNDER 65 EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*65-74*;
%DESCRIPTIVE_TBL (DAT=SSN, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=SEX=1 AND AGE_INT GE 65 AND AGE_INT LT 75,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - WOMEN 65-74,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - WOMEN 65-74 EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*75+*;
%DESCRIPTIVE_TBL (DAT=SSN, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=SEX=1 AND AGE_INT GE 75,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - WOMEN 75 AND OVER,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - WOMEN 75 AND OVER EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*MEN*;

*UNDER 65*;
%DESCRIPTIVE_TBL (DAT=SSN, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=SEX=0 AND AGE_INT LT 65,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - MEN UNDER 65,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - MEN UNDER 65 EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*65-74*;
%DESCRIPTIVE_TBL (DAT=SSN, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=SEX=0 AND AGE_INT GE 65 AND AGE_INT LT 75,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - MEN 65-74,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - MEN 65-74 EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 

*75+*;
%DESCRIPTIVE_TBL (DAT=SSN, EXPOSURE=BSINDEX, COVCAT=ssn_status,COVCONT=, ORDER=FORMATTED, ROWCOL=COL,CHI=1,LIMIT=SEX=0 AND AGE_INT GE 75,
				      PERDEC=0.1, CONTMEAS=MEANSD, PRINTOUT=0,TOTAL=0,COLWDTH=40,STARTLAB=,TITL=SSI AND SSN - MEN 75 AND OVER,
				      ODSTYPE=RTF,ODSSTYLE=Minimal,ODSPATH= D:\USER\JBLASE\Social Support\OUTPUT\SSI AND SSN - MEN 75 AND OVER EX ALTERED SSN &SYSDATE..RTF,
                      ORIENT=LANDSCAPE); 



************************************************************************************************;
*AGE AT BASELINE STRATIFIED BY SEX AND FOLLOW-UP TIME EXCLUDING PEOPLE WITHOUT SSN AT BASELINE *;
************************************************************************************************;
OPTIONS MPRINT;

*********;
*FEMALES*;
*********;

*LESS THAN 65 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65 AND SEX=1,POP=FIRST PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT LT 65 AND SEX=1,POP=SECOND PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT LT 65 AND SEX=1,POP=THIRD PERIOD, AGEDESC=LT65);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS LT 65 YEARS AT BL FEMALES EX SSN - &SYSDATE..RTF";

TITLE 'FIRST PERIOD, LT 65 YEARS AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, LT 65 YEARS AT BL FEMALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, LT 65 YEARS AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*BETWEEN 65-74 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=1,POP=FIRST PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=1,POP=SECOND PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=1,POP=THIRD PERIOD, AGEDESC=BW65_74);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 65-74 YEARS AT BL FEMALES EX SSN- &SYSDATE..RTF";

TITLE 'FIRST PERIOD, 65-74 YEARS AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, 65-74 YEARS AT BL FEMALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, 65-74 YEARS AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*75+ YEARS AT BASELINE*;
%COX_SEX  (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75 AND SEX=1,POP=FIRST PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT GE 75 AND SEX=1,POP=SECOND PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT GE 75 AND SEX=1,POP=THIRD PERIOD, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS 75+ YEARS AT BL FEMALES EX SSN - &SYSDATE..RTF";

TITLE 'FIRST PERIOD, 75+ YEARS AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, 75+ YEARS AT BL FEMALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, 75+ YEARS AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*AGE AT BASELINE MODELS IN FEMALES (NOT STRATIFIED BY FOLLOW UP TIME)*;

	*<65 IN MONTHS*;
	PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=LT65_ALL_F;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT LT 65 AND SEX=1;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE <65';
			TITLE3 'POPULATION: FEMALES ONLY';
			TITLE4 'EXCLUDING MISSING SSN';
      RUN;
	  ODS OUTPUT CLOSE;

DATA LT65_ALL_NEW_F;
SET LT65_ALL_F;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=LT65_ALL_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1 AND AGE_INT LT 65;
RUN;
ODS OUTPUT CLOSE;


*65-74 YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=BW65_74_ALL_F;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 65 AND AGE_INT LT 75 AND SEX=1;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 65-74';
			TITLE3 'POPULATION: FEMALES ONLY';
			TITLE4 'EXCLUDING MISSING SSN';
      RUN;
	  ODS OUTPUT CLOSE;

DATA BW65_74_ALL_NEW_F;
SET BW65_74_ALL_F;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=BW65_74_ALL_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1 AND AGE_INT GE 65 AND AGE_INT LT 75;
RUN;
ODS OUTPUT CLOSE;


*75+ YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=GE75_ALL_F;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 75 AND SEX=1;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 75+';
			TITLE3 'POPULATION: FEMALES ONLY';
			TITLE4 'EXCLUDING MISSING SSN';
      RUN;
	  ODS OUTPUT CLOSE;

DATA GE75_ALL_NEW_F;
SET GE75_ALL_F;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=GE75_ALL_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1 AND AGE_INT GE 75;
RUN;
ODS OUTPUT CLOSE;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY AGE AT BL MODELS FEMALES EX SSN - &SYSDATE..RTF";

TITLE '1982-2012, FEMALES UNDER 65 YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA=LT65_ALL_FREQ; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=LT65_ALL_NEW_F; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, FEMALES 65-74 YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA=BW65_74_ALL_FREQ; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=BW65_74_ALL_NEW_F; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, FEMALES 75+ YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA=GE75_ALL_FREQ; VAR BSINDEX FREQUENCY; RUN; PROC PRINT DATA=GE75_ALL_NEW_F; VAR ClassVal0 RR CI; RUN;


ODS RTF CLOSE;

*MODELS NOT STRATIFIED BY AGE AT BASELINE BUT STRATIFIED BY FU PERIOD*;

%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND SEX=1,POP=FIRST PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND SEX=1,POP=SECOND PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND SEX=1,POP=THIRD PERIOD, AGEDESC=ALLAGE);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS ALL AGES AT BL FEMALES EX SSN - &SYSDATE..RTF";

TITLE 'FIRST PERIOD, ALL AGES AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, ALL AGES AT BL FEMALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, ALL AGES AT BL FEMALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*ALL FEMALES - NOT STRATIFIED BY FU TIME OR AGE AT BL*;

PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_FEMALES;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE SEX=1;
            STRATA AGE_INT;
            TITLE2 'POPULATION: FEMALES ONLY';
			TITLE3 'EXCLUDING OBS MISSING SSN';
      RUN;
ODS OUTPUT CLOSE;

DATA ALL_FEMALES_NEW;
SET ALL_FEMALES;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=ALL_FEMALES_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=1 AND ALLCAUSE=1;
RUN;
ODS OUTPUT CLOSE;

DATA ALL_FEMALES_FREQ_NEW;
SET ALL_FEMALES_FREQ;

FREQ=PUT(FREQUENCY, COMMA7.);

RUN;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK FEMALES NON-STRATIFIED EX SSN - &SYSDATE..RTF";

TITLE 'FEMALES, ALL AGES AND TIME PERIODS, EXCLUDING MISSING SSN'; PROC PRINT DATA=ALL_FEMALES_FREQ_NEW; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=ALL_FEMALES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*******;
*MALES*;
*******;

*LESS THAN 65 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65 AND SEX=0,POP=FIRST PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT LT 65 AND SEX=0,POP=SECOND PERIOD, AGEDESC=LT65)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT LT 65 AND SEX=0,POP=THIRD PERIOD, AGEDESC=LT65);

*BETWEEN 65-74 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=0,POP=FIRST PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=0,POP=SECOND PERIOD, AGEDESC=BW65_74)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75) AND SEX=0,POP=THIRD PERIOD, AGEDESC=BW65_74);

*75+ YEARS AT BASELINE*;
%COX_SEX  (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75 AND SEX=0,POP=FIRST PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT GE 75 AND SEX=0,POP=SECOND PERIOD, AGEDESC=GE75)
%COX_SEX  (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT GE 75 AND SEX=0,POP=THIRD PERIOD, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS AGE AT BL AND FOLLOW-UP TIME MALES EX SSN - &SYSDATE..RTF";

TITLE 'FIRST PERIOD, LT 65 YEARS AT BL MALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, LT 65 YEARS AT BL MALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, LT 65 YEARS AT BL MALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE 'FIRST PERIOD, 65-74 YEARS AT BL MALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, 65-74 YEARS AT BL MALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, 65-74 YEARS AT BL MALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE 'FIRST PERIOD, 75+ YEARS AT BL MALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, 75+ YEARS AT BL MALES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, 75+ YEARS AT BL MALES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*AGE AT BASELINE MODELS IN MALES (NOT STRATIFIED BY FOLLOW UP TIME)*;

	*<65 IN MONTHS*;
	PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=LT65_ALL_M;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT LT 65 AND SEX=0;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE <65';
			TITLE3 'POPULATION: MALES ONLY';
			TITLE3 'EXCLUDING OBS MISSING SSN';
      RUN;
	  ODS OUTPUT CLOSE;

DATA LT65_ALL_NEW_M;
SET LT65_ALL_M;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=LT65_ALL_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1 AND AGE_INT LT 65;
RUN;
ODS OUTPUT CLOSE;

DATA LT65_ALL_FREQ_NEW;
SET LT65_ALL_FREQ;

FREQ=PUT(FREQUENCY, COMMA7.);

RUN;



*65-74 YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=BW65_74_ALL_M;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 65 AND AGE_INT LT 75 AND SEX=0;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 65-74';
			TITLE3 'POPULATION: MALES ONLY';
			TITLE3 'EXCLUDING OBS MISSING SSN';
      RUN;
	  ODS OUTPUT CLOSE;

DATA BW65_74_ALL_NEW_M;
SET BW65_74_ALL_M;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=BW65_74_ALL_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1 AND AGE_INT GE 65 AND AGE_INT LT 75;
RUN;
ODS OUTPUT CLOSE;

DATA BW65_74_ALL_FREQ_NEW;
SET BW65_74_ALL_FREQ;

FREQ=PUT(FREQUENCY, COMMA7.);

RUN;


*75+ YEARS IN MONTHS*;
	PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=GE75_ALL_M;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE AGE_INT GE 75 AND SEX=0;
            STRATA AGE_INT;
            TITLE2 'AGE AT BASELINE 75+';
			TITLE3 'POPULATION: MALES ONLY';
			TITLE3 'EXCLUDING OBS MISSING SSN';
      RUN;
	  ODS OUTPUT CLOSE;

DATA GE75_ALL_NEW_M;
SET GE75_ALL_M;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=GE75_ALL_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1 AND AGE_INT GE 75;
RUN;
ODS OUTPUT CLOSE;

DATA GE75_ALL_FREQ_NEW;
SET GE75_ALL_FREQ;

FREQ=PUT(FREQUENCY, COMMA7.);

RUN;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY AGE AT BL MODELS MALES EX SSN - &SYSDATE..RTF";

TITLE '1982-2012, MALES UNDER 65 YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA=LT65_ALL_FREQ_NEW; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=LT65_ALL_NEW_M; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, MALES 65-74 YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA=BW65_74_ALL_FREQ_NEW; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=BW65_74_ALL_NEW_M; VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, MALES 75+ YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA=GE75_ALL_FREQ_NEW; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=GE75_ALL_NEW_M; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*MODELS NOT STRATIFIED BY AGE AT BASELINE BUT STRATIFIED BY FU PERIOD*;

%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND SEX=0,POP=FIRST PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND SEX=0,POP=SECOND PERIOD, AGEDESC=ALLAGE)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND SEX=0,POP=THIRD PERIOD, AGEDESC=ALLAGE);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS ALL AGES AT BL MALES EX SSN- &SYSDATE..RTF";

TITLE 'FIRST PERIOD, MALES ALL AGES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, MALES ALL AGES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, MALES ALL AGES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


TITLE; TITLE2; TITLE3;

*ALL MALES - NOT STRATIFIED BY FU TIME OR AGE AT BL*;

PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_MALES;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            WHERE SEX=0;
            STRATA AGE_INT;
            TITLE2 'POPULATION: MALES ONLY';
			TITLE3 'EXCLUDING OBS MISSING SSN';
      RUN;
ODS OUTPUT CLOSE;

DATA ALL_MALES_NEW;
SET ALL_MALES;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=ALL_MALES_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE SEX=0 AND ALLCAUSE=1;
RUN;
ODS OUTPUT CLOSE;

DATA ALL_MALES_FREQ_NEW;
SET ALL_MALES_FREQ;

FREQ=PUT(FREQUENCY, COMMA7.);

RUN;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK MALES NON-STRATIFIED EX SSN - &SYSDATE..RTF";

TITLE 'MALES, ALL AGES AND TIME PERIODS, EXCLUDING MISSING SSN'; PROC PRINT DATA=ALL_MALES_FREQ_NEW; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=ALL_MALES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


***************;
*ENTIRE COHORT*;
***************;

*LESS THAN 65 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, AGEDESC=LT65, COV=SEX)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT LT 65,POP=SECOND PERIOD, AGEDESC=LT65, COV=SEX)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT LT 65,POP=THIRD PERIOD, AGEDESC=LT65, COV=SEX);

*BETWEEN 65-74 YEARS AT BASELINE*;
%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, AGEDESC=BW65_74, COV=SEX)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, AGEDESC=BW65_74, COV=SEX)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, AGEDESC=BW65_74, COV=SEX);

*75+ YEARS AT BASELINE*;
%COX_SEX  (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, AGEDESC=GE75, COV=SEX)
%COX_SEX  (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE . AND AGE_INT GE 75,POP=SECOND PERIOD, AGEDESC=GE75, COV=SEX)
%COX_SEX  (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE . AND AGE_INT GE 75,POP=THIRD PERIOD, AGEDESC=GE75, COV=SEX);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS AGE AT BL AND FOLLOW-UP TIME ENTIRE COHORT EX SSN - &SYSDATE..RTF";

TITLE 'FIRST PERIOD, LT 65 YEARS AT BL, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, LT 65 YEARS AT BL, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, LT 65 YEARS AT BL, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE 'FIRST PERIOD, 65-74 YEARS AT BL, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, 65-74 YEARS AT BL, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, 65-74 YEARS AT BL, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE 'FIRST PERIOD, 75+ YEARS AT BL, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, 75+ YEARS AT BL, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, 75+ YEARS AT BL, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*AGE AT BASELINE MODELS IN ENTIRE COHORT STRATIFIED BY AGE AT BL (NOT STRATIFIED BY FOLLOW UP TIME)*;

%COX_SEX (DATSET=SPLIT_SSN,FT=MONTH,CSOR=ALLCAUSE,COND=AGE_INT LT 65,POP=LESS THAN 65 YEARS, AGEDESC=LT65, COV=SEX);
%COX_SEX (DATSET=SPLIT_SSN,FT=MONTH,CSOR=ALLCAUSE,COND=AGE_INT GE 65 AND AGE_INT LT 75,POP=BETWEEN 65-74 YEARS, AGEDESC=BW65_74, COV=SEX);
%COX_SEX (DATSET=SPLIT_SSN,FT=MONTH,CSOR=ALLCAUSE,COND=AGE_INT GE 75,POP=75+ YEARS, AGEDESC=GE75, COV=SEX);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK 3-CATEGORY AGE AT BL MODELS ENTIRE COHORT EX SSN - &SYSDATE..RTF";

TITLE '1982-2012, ENTIRE COHORT UNDER 65 YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA= SPLIT_SSN_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SPLIT_SSN_LT65_NEW; 
VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, ENTIRE COHORT 65-74 YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA= SPLIT_SSN_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SPLIT_SSN_BW65_74_NEW; 
VAR ClassVal0 RR CI; RUN;
TITLE '1982-2012, ENTIRE COHORT 75+ YEARS, EXCLUDING MISSING SSN'; PROC PRINT DATA= SPLIT_SSN_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SPLIT_SSN_GE75_NEW; 
VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*MODELS NOT STRATIFIED BY AGE AT BASELINE BUT STRATIFIED BY FU PERIOD*;

%COX_SEX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, AGEDESC=ALLAGE, COV=SEX)
%COX_SEX (DATSET=SECOND,FT=FAIL2B,CSOR=CORE2B,COND=FAIL2B NE .,POP=SECOND PERIOD, AGEDESC=ALLAGE, COV=SEX)
%COX_SEX (DATSET=THIRD,FT=FAIL3B,CSOR=CORE3B,COND=FAIL3B NE .,POP=THIRD PERIOD, AGEDESC=ALLAGE, COV=SEX);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK STRATIFIED MODELS ALL AGES AT BL ENTIRE COHORT EX SSN- &SYSDATE..RTF";

TITLE 'FIRST PERIOD, ENTIRE COHORT ALL AGES, EXCLUDING MISSING SSN'; PROC PRINT DATA=FIRST_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA= FIRST_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;
TITLE 'SECOND PERIOD, ENTIRE COHORT ALL AGES, EXCLUDING MISSING SSN';PROC PRINT DATA=SECOND_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=SECOND_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN; 
TITLE 'THIRD PERIOD, ENTIRE COHORT ALL AGES, EXCLUDING MISSING SSN'; PROC PRINT DATA=THIRD_ALLAGE_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_ALLAGE_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*ENTIRE COHORT - NOT STRATIFIED BY FU TIME OR AGE AT BL*;

PROC PHREG DATA=SPLIT_SSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_COHORT;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK SEX/RL;
            STRATA AGE_INT;
            TITLE2 'POPULATION: ENTIRE COHORT ONLY';
			TITLE3 'EXCLUDING OBS MISSING SSN';
      RUN;
ODS OUTPUT CLOSE;

DATA ALL_COHORT_NEW;
SET ALL_COHORT;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT OneWayFreqs=ALL_COHORT_FREQ;
PROC FREQ DATA=SPLIT_SSN;
     TABLES BSINDEX/NOROW NOCOL NOPERCENT NOCUM;
     WHERE ALLCAUSE=1;
RUN;
ODS OUTPUT CLOSE;

DATA ALL_COHORT_FREQ_NEW;
SET ALL_COHORT_FREQ;

FREQ=PUT(FREQUENCY, COMMA7.);

RUN;


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\PH CHECK ENTIRE COHORT NON-STRATIFIED EX SSN - &SYSDATE..RTF";

TITLE 'ENTIRE COHORT, ALL AGES AND TIME PERIODS, EXCLUDING MISSING SSN'; PROC PRINT DATA=ALL_COHORT_FREQ_NEW; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=ALL_COHORT_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*CREATING GRAPH FOR WIP*;
*BIRTH COHORT WITH SSN IN 1982*;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
WHERE SSN_1982='Y';
TABLES B_COHORT;
RUN;

*BIRTH COHORT WITHOUT SSN IN 1982*;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
WHERE SSN_1982='N';
TABLES B_COHORT;
RUN;

*BIRTH COHORT WITH SSN IN 2012*;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
WHERE SSN_1982='Y' AND DEAD=0;
TABLES B_COHORT;
RUN;

*BIRTH COHORT WITHOUT SSN IN 2012*;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
WHERE SSN_1982='N' AND DEAD=0;
TABLES B_COHORT;
RUN;


***NO EXCLUSIONS ON SSN, CENSORED AT ATTAINED AGE=90, NOT STRATIFIED BY SEX***;

*USED THIS MACRO FROM ABOVE (SO MANY MACROS!)*;
*CUSTOMIZABLE MACRO FOR ATTAINED AGE STRATIFIED BY FU PERIOD*;

*AGEDESC = DESCRIPTION OF AGE GROUP (MUST BE ONE WORD, CAN'T START WITH SYMBOLS)*;
*AGEGRP = DIVIDES OUT THE AGE GROUPS, CAN USE SYMBOLS*;
*CSORAGE = AGE CENSORING AT*;

%MACRO COX (DATSET=,FT=,CSOR=,COND=,POP=,FLPERIODS=,AGEDESC=,AGEGRP=,CSORAGE=);
	  ODS OUTPUT PARAMETERESTIMATES=&DATSET._&AGEDESC;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK &CSORAGE/RL; 
	  AGENOW=BEGAGE82_YRS + ((&FLPERIODS)/12) - 1/365.25;
      IF %STR(&AGEGRP) THEN &CSORAGE=1;
	  STRATA AGE_INT; 
      WHERE &COND;   

	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';  
	  TITLE7 "AGE GROUP: &AGEDESC"; 
      RUN;  
	  ODS OUTPUT CLOSE;

	  DATA &DATSET._&AGEDESC._NEW;
		SET &DATSET._&AGEDESC;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");
RUN;


%*ODS OUTPUT CrossTabFreqs=&DATSET._&AGEDESC._FREQ;
%*PROC FREQ DATA=&DATSET;
 %*    TABLES BSINDEX*&CSOR/NOROW NOCOL NOPERCENT NOCUM;
  %*   WHERE &COND;
%*RUN;
%*ODS OUTPUT CLOSE;

%*DATA &DATSET._&AGEDESC._FREQN;
%*SET &DATSET._&AGEDESC._FREQ;

%*IF &CSOR=1;
%*FREQ=PUT(FREQUENCY, COMMA7.);

%*RUN;

%MEND COX;


*ATTAINED AGE CALCULATED IN THE MODELS BELOW*;
***CENSORED AT 90 YEARS***;

*<65 YRS AT BASELINE, CENSORED AT ATTAINED AGE=90*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=LT65, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT LT 65,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=LT65, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT LT 65,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=LT65, AGEGRP=AGENOW<90, CSORAGE=AGE90);

*65-74 YRS AT BASELINE, CENSORED AT ATTAINED AGE=90*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=BW65_74, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=BW65_74, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=BW65_74, AGEGRP=AGENOW<90, CSORAGE=AGE90);

*75+ YRS AT BASELINE, CENSORED AT ATTAINED AGE=90*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=GE75, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT GE 75,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=GE75, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT GE 75,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=GE75, AGEGRP=AGENOW<90, CSORAGE=AGE90);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\CENSORED AT 90 - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION (MALES AND FEMALES) STRATIFIED BY FOLLOW UP TIME AND TIME AT BL, CENSORED AT AGE=90';

TITLE2 'FIRST PERIOD, LESS THAN 65'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, LESS THAN 65'; PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, LESS THAN 65'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 65-74'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 65-74'; PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 65-74'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 75+'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 75+'; PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 75+'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*CENSORED AT 90 YEARS, LESS THAN 65 AT BASELINE, NOT STRATIFIED BY FU TIME*;

	  ODS OUTPUT PARAMETERESTIMATES=UNDER65;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT90/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF AGENOW<90 THEN LT90=1;
		    WHERE AGE_INT LT 65;
            STRATA AGE_INT;
            TITLE2 'CENSORED ON ATTAINED AGE 90';
      RUN;
	  ODS OUTPUT CLOSE;


DATA UNDER65_NEW;
		SET UNDER65;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

*CENSORED AT 90 YEARS, 65-74 YEARS AT BASELINE, NOT STRATIFIED BY FU TIME*;

ODS OUTPUT PARAMETERESTIMATES=BW65_74;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT90/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF AGENOW<90 THEN LT90=1;
		    WHERE AGE_INT GE 65 AND AGE_INT LE 74;
            STRATA AGE_INT;
            TITLE2 'CENSORED ON ATTAINED AGE 90';
      RUN;
	  ODS OUTPUT CLOSE;


DATA BW65_74_NEW;
		SET BW65_74;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

*CENSORED AT 90 YEARS, 75+ YEARS AT BASELINE, NOT STRATIFIED BY FU TIME*;

ODS OUTPUT PARAMETERESTIMATES=GE75;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT90/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF AGENOW<90 THEN LT90=1;
		    WHERE AGE_INT GE 65 AND AGE_INT LE 74;
            STRATA AGE_INT;
            TITLE2 'CENSORED ON ATTAINED AGE 90';
      RUN;
	  ODS OUTPUT CLOSE;


DATA GE75_NEW;
		SET GE75;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\CENSORED AT 90, STRATIFIED BY BL AGE ONLY - &SYSDATE..RTF";

TITLE 'CENSORED AT 90, STRATIFIED BY AGE AT BASELINE, NOT STRATIFIED BY FOLLOW UP TIME';

TITLE2 'CENSORED AT 90, LESS THAN 65 AT BASELINE'; PROC PRINT DATA=UNDER65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'CENSORED AT 90, 65-74 AT BASELINE'; PROC PRINT DATA=BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'CENSORED AT 90, 75+ AT BASELINE'; PROC PRINT DATA=GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*CENSORED AT 90, NOT STRATIFIED BY AGE AT BL, ONLY STRATIFIED BY TIME AT FOLLOW UP*;

%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=TOTPOP, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=TOTPOP, AGEGRP=AGENOW<90, CSORAGE=AGE90);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=TOTPOP, AGEGRP=AGENOW<90, CSORAGE=AGE90);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\CENSORED AT 90, STRATIFIED BY FU TIME ONLY - &SYSDATE..RTF";

TITLE 'CENSORED AT 90, STRATIFIED BY FU TIME, NOT STRATIFIED BY AGE AT BASELINE';

TITLE2 'FIRST TIME PERIOD'; PROC PRINT DATA=FIRST_TOTPOP_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND TIME PERIOD'; PROC PRINT DATA=SECOND_TOTPOP_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD TIME PERIOD'; PROC PRINT DATA=THIRD_TOTPOP_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


***CENSORED AT 95 YEARS***;

*<65 YRS AT BASELINE, CENSORED AT ATTAINED AGE=95*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=LT65, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT LT 65,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=LT65, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT LT 65,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=LT65, AGEGRP=AGENOW<95, CSORAGE=AGE95);

*65-74 YRS AT BASELINE, CENSORED AT ATTAINED AGE=95*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=BW65_74, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=BW65_74, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=BW65_74, AGEGRP=AGENOW<95, CSORAGE=AGE95);

*75+ YRS AT BASELINE, CENSORED AT ATTAINED AGE=95*;
%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=GE75, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT GE 75,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=GE75, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT GE 75,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=GE75, AGEGRP=AGENOW<95, CSORAGE=AGE95);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\CENSORED AT 95 - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION (MALES AND FEMALES) STRATIFIED BY FOLLOW UP TIME AND TIME AT BL, CENSORED AT AGE=95';

TITLE2 'FIRST PERIOD, LESS THAN 65'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, LESS THAN 65'; PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, LESS THAN 65'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 65-74'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 65-74'; PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 65-74'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 75+'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 75+'; PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 75+'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

*CENSORED AT 95 YEARS, LESS THAN 65 AT BASELINE, NOT STRATIFIED BY FU TIME*;

	  ODS OUTPUT PARAMETERESTIMATES=UNDER65;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT95/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF AGENOW<95 THEN LT95=1;
		    WHERE AGE_INT LT 65;
            STRATA AGE_INT;
            TITLE2 'CENSORED ON ATTAINED AGE 95';
      RUN;
	  ODS OUTPUT CLOSE;


DATA UNDER65_NEW;
		SET UNDER65;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;


*CENSORED AT 95 YEARS, 65-74 YEARS AT BASELINE, NOT STRATIFIED BY FU TIME*;

ODS OUTPUT PARAMETERESTIMATES=BW65_74;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT95/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF AGENOW<95 THEN LT95=1;
		    WHERE AGE_INT GE 65 AND AGE_INT LE 74; 
            STRATA AGE_INT;
            TITLE2 'CENSORED ON ATTAINED AGE 95';
      RUN;
	  ODS OUTPUT CLOSE;


DATA BW65_74_NEW;
		SET BW65_74;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

*CENSORED AT 95 YEARS, 75+ YEARS AT BASELINE, NOT STRATIFIED BY FU TIME*;

ODS OUTPUT PARAMETERESTIMATES=GE75;
	  PROC PHREG DATA=SPLIT MULTIPASS;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK LT95/RL;
            AGENOW=(BEGAGE82_YRS + MONTH/12) - 1/365.25;
            IF AGENOW<95 THEN LT95=1;
		    WHERE AGE_INT GE 65 AND AGE_INT LE 74;
            STRATA AGE_INT;
            TITLE2 'CENSORED ON ATTAINED AGE 95';
      RUN;
	  ODS OUTPUT CLOSE;


DATA GE75_NEW;
		SET GE75;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\CENSORED AT 95, STRATIFIED BY BL AGE ONLY - &SYSDATE..RTF";

TITLE 'CENSORED AT 95, STRATIFIED BY AGE AT BASELINE, NOT STRATIFIED BY FOLLOW UP TIME';

TITLE2 'CENSORED AT 95, LESS THAN 65 AT BASELINE'; PROC PRINT DATA=UNDER65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'CENSORED AT 95, 65-74 AT BASELINE'; PROC PRINT DATA=BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'CENSORED AT 95, 75+ AT BASELINE'; PROC PRINT DATA=GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*CENSORED AT 95, NOT STRATIFIED BY AGE AT BL, ONLY STRATIFIED BY TIME AT FOLLOW UP*;

%COX (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, FLPERIODS=FAIL1B_MO, AGEDESC=TOTPOP, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, FLPERIODS=FAIL2B_MO+FAIL1B_MO, AGEDESC=TOTPOP, AGEGRP=AGENOW<95, CSORAGE=AGE95);
%COX (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, FLPERIODS=FAIL3B_MO+FAIL2B_MO+FAIL1B_MO, AGEDESC=TOTPOP, AGEGRP=AGENOW<95, CSORAGE=AGE95);


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\CENSORED AT 95, STRATIFIED BY FU TIME ONLY - &SYSDATE..RTF";

TITLE 'CENSORED AT 95, STRATIFIED BY FU TIME, NOT STRATIFIED BY AGE AT BASELINE';

TITLE2 'FIRST TIME PERIOD'; PROC PRINT DATA=FIRST_TOTPOP_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND TIME PERIOD'; PROC PRINT DATA=SECOND_TOTPOP_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD TIME PERIOD'; PROC PRINT DATA=THIRD_TOTPOP_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


**********************************************************************************************************************;

%MACRO COX_NEW (DATSET=,FT=,CSOR=,COND=,POP=,AGEDESC=);

ODS OUTPUT PARAMETERESTIMATES=&DATSET._&AGEDESC;
      PROC PHREG DATA=&DATSET;
	  CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/REF=FIRST ORDER=INTERNAL; 
      MODEL &FT * &CSOR(0) = BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL; 
	  STRATA AGE_INT; 
      WHERE &COND;   

	  TITLE1 'OUTCOME: ALL CAUSE MORTALITY';                           
      TITLE2 "POPULATION: &POP";                  
      TITLE3 'MAIN EXPOSURE OF INTEREST: SOCIAL INDEX SCORE';                             
      TITLE4 'REFERENT: LEAST ISOLATED (I)';                                       
      TITLE5 'STRATIFIED VARIABLE: AGE AT INTERVIEW';                           
      TITLE6 'MULTIVARIATE MODEL';  
	  TITLE7 "AGE GROUP: &AGEDESC"; 
      RUN;  
	  ODS OUTPUT CLOSE;

	  DATA &DATSET._&AGEDESC._NEW;
		SET &DATSET._&AGEDESC;

	IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");
RUN;

ODS OUTPUT CrossTabFreqs=&DATSET._&AGEDESC._FREQ;
PROC FREQ DATA=&DATSET;
     TABLES BSINDEX*&CSOR/NOROW NOCOL NOPERCENT NOCUM;
   WHERE &COND;
RUN;
ODS OUTPUT CLOSE;

DATA &DATSET._&AGEDESC._FREQN;
SET &DATSET._&AGEDESC._FREQ;

IF &CSOR=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;


%MEND COX_NEW;


********************;
***CENSORED AT 90***;
********************;
*NOTE: THESE WERE THE CORRECT NUMBERS THAT WENT INTO THE TABLE*;

*BOTTOM ROW OF TABLE (NOT STRATIFED BY FU TIME)*;
%COX_NEW (DATSET=SPLIT2,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT LT 65,POP=UNDER 65, AGEDESC=LT65);
%COX_NEW (DATSET=SPLIT2,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT GE 65 AND AGE_INT LE 74,POP=AGE 65-74, AGEDESC=BW65_74);
%COX_NEW (DATSET=SPLIT2,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT GE 75 ,POP=AGE 75+, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 90 BOTTOM ROW - &SYSDATE..RTF";

TITLE2 'LESS THAN 65'; PROC PRINT DATA=SPLIT2_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLIT2_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 '65-74 YEARS'; PROC PRINT DATA=SPLIT2_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLIT2_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 '75+'; PROC PRINT DATA=SPLIT2_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLIT2_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*STRATIFIED BY FOLLOW UP TIME AND AGE AT BL*;
*LESS THAN 65*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, AGEDESC=LT65);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT LT 65,POP=SECOND PERIOD, AGEDESC=LT65);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT LT 65,POP=THIRD PERIOD, AGEDESC=LT65);

*65-74 YEARS*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, AGEDESC=BW65_74);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, AGEDESC=BW65_74);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, AGEDESC=BW65_74);

*75+*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, AGEDESC=GE75);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT GE 75,POP=SECOND PERIOD, AGEDESC=GE75);
%*COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT GE 75,POP=THIRD PERIOD, AGEDESC=GE75); *THERE IS NO ONE IN THIS DATASET SINCE EVERYONE
HAS ATTAINED AGE OVER 90*;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 90 - STRAT FU TIME AND AGE AT BL - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION STRATIFIED BY FOLLOW UP TIME AND TIME AT BL, CENSORED AT AGE=90';

TITLE2 'FIRST PERIOD, LESS THAN 65'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, LESS THAN 65'; PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, LESS THAN 65'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 65-74'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 65-74'; PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 65-74'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 75+'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 75+'; PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN;
/*TITLE2 'THIRD PERIOD, 75+'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;*/
*NO ONE IN DATASET SINCE EVERYONE HAS ATTAINED AGE OVER 90*;

ODS RTF CLOSE;


*STRATIFIED BY FOLLOW UP PERIOD ONLY (NOT STRATIFIED BY AGE)*;

%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, AGEDESC=ALLAGES);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, AGEDESC=ALLAGES);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, AGEDESC=ALLAGES);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 90 - STRAT FU TIME ONLY, RIGHT COLUMN - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION STRATIFIED BY FOLLOW UP TIME ONLY, CENSORED AT AGE=90';

TITLE2 'FIRST PERIOD'; PROC PRINT DATA=FIRST_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD'; PROC PRINT DATA=SECOND_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD'; PROC PRINT DATA=THIRD_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=THIRD_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


PROC PHREG DATA=SPLIT90 MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_CENS90;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL FAILNEW_MO*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            STRATA AGE_INT;
            TITLE2 'ENTIRE POPULATION, CENSORED AT 90';      
RUN;
ODS OUTPUT CLOSE;

DATA ALL_CENS90_NEW;
SET ALL_CENS90;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT CrossTabFreqs=SPLIT90_FREQ;
PROC FREQ DATA=SPLIT90;
     TABLES BSINDEX*ALLCAUSE/NOROW NOCOL NOPERCENT NOCUM;
RUN;
ODS OUTPUT CLOSE;

DATA SPLIT90_FREQN;
SET SPLIT90_FREQ;

IF ALLCAUSE=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 90 TOTAL POP, NON STRAT - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION NOT STRATIFIED, CENSORED AT AGE=90, BOTTOM RIGHT CORNER';
TITLE2;
PROC PRINT DATA=SPLIT90_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=ALL_CENS90_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


***************************************************************************************************;

********************;
***CENSORED AT 95***;
********************;
*NOTE: THESE WERE THE CORRECT NUMBERS THAT WENT INTO THE TABLE*;

*BOTTOM ROW OF TABLE (NOT STRATIFED BY FU TIME)*;
%COX_NEW (DATSET=SPLIT95,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT LT 65,POP=UNDER 65, AGEDESC=LT65);
%COX_NEW (DATSET=SPLIT95,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT GE 65 AND AGE_INT LE 74,POP=AGE 65-74, AGEDESC=BW65_74);
%COX_NEW (DATSET=SPLIT95,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT GE 75 ,POP=AGE 75+, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 95 BOTTOM ROW - &SYSDATE..RTF";

TITLE2 'LESS THAN 65'; PROC PRINT DATA=SPLIT95_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLIT95_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 '65-74 YEARS'; PROC PRINT DATA=SPLIT95_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLIT95_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 '75+'; PROC PRINT DATA=SPLIT95_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLIT95_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*STRATIFIED BY FOLLOW UP TIME AND AGE AT BL*;
*LESS THAN 65*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, AGEDESC=LT65);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT LT 65,POP=SECOND PERIOD, AGEDESC=LT65);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT LT 65,POP=THIRD PERIOD, AGEDESC=LT65);

*65-74 YEARS*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, AGEDESC=BW65_74);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, AGEDESC=BW65_74);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, AGEDESC=BW65_74);

*75+*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, AGEDESC=GE75);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT GE 75,POP=SECOND PERIOD, AGEDESC=GE75);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT GE 75,POP=THIRD PERIOD, AGEDESC=GE75); 


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 95 - STRAT FU TIME AND AGE AT BL - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION STRATIFIED BY FOLLOW UP TIME AND TIME AT BL, CENSORED AT AGE=95';

TITLE2 'FIRST PERIOD, LESS THAN 65'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, LESS THAN 65'; PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, LESS THAN 65'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 65-74'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 65-74'; PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 65-74'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 75+'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 75+'; PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 75+'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*STRATIFIED BY FOLLOW UP PERIOD ONLY (NOT STRATIFIED BY AGE)*;

%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, AGEDESC=ALLAGES);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, AGEDESC=ALLAGES);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, AGEDESC=ALLAGES);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 95 - STRAT FU TIME ONLY, RIGHT COLUMN - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION STRATIFIED BY FOLLOW UP TIME ONLY, CENSORED AT AGE=95';

TITLE2 'FIRST PERIOD'; PROC PRINT DATA=FIRST_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD'; PROC PRINT DATA=SECOND_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD'; PROC PRINT DATA=THIRD_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=THIRD_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

PROC PHREG DATA=SPLIT95 MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_CENS95;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL FAILNEW_MO*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            STRATA AGE_INT;
            TITLE2 'ENTIRE POPULATION, CENSORED AT 95';      
RUN;
ODS OUTPUT CLOSE;

DATA ALL_CENS95_NEW;
SET ALL_CENS95;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT CrossTabFreqs=SPLIT95_FREQ;
PROC FREQ DATA=SPLIT95;
     TABLES BSINDEX*ALLCAUSE/NOROW NOCOL NOPERCENT NOCUM;
RUN;
ODS OUTPUT CLOSE;

DATA SPLIT95_FREQN;
SET SPLIT95_FREQ;

IF ALLCAUSE=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 95 TOTAL POP, NON STRAT - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION NOT STRATIFIED, CENSORED AT AGE=95, BOTTOM RIGHT CORNER';
TITLE2;
PROC PRINT DATA=SPLIT95_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=ALL_CENS95_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


***************************************************************************************************;

***********************************************************;
****CENSORED DIFFERENTIALLY BY SSN - (NO SSN=90, SSN=95)***;
***********************************************************;
*NOTE: THESE WERE THE CORRECT NUMBERS THAT WENT INTO THE TABLE*;

*BOTTOM ROW OF TABLE (NOT STRATIFED BY FU TIME)*;
%COX_NEW (DATSET=SPLITSSN,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT LT 65,POP=UNDER 65, AGEDESC=LT65);
%COX_NEW (DATSET=SPLITSSN,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT GE 65 AND AGE_INT LE 74,POP=AGE 65-74, AGEDESC=BW65_74);
%COX_NEW (DATSET=SPLITSSN,FT=FAILNEW_MO,CSOR=ALLCAUSE,COND=AGE_INT GE 75 ,POP=AGE 75+, AGEDESC=GE75);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED DIFFERENTIALLY BY SSN, BOTTOM ROW - &SYSDATE..RTF";

TITLE2 'LESS THAN 65'; PROC PRINT DATA=SPLITSSN_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLITSSN_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 '65-74 YEARS'; PROC PRINT DATA=SPLITSSN_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLITSSN_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 '75+'; PROC PRINT DATA=SPLITSSN_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SPLITSSN_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*STRATIFIED BY FOLLOW UP TIME AND AGE AT BL*;
*LESS THAN 65*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT LT 65,POP=FIRST PERIOD, AGEDESC=LT65);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT LT 65,POP=SECOND PERIOD, AGEDESC=LT65);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT LT 65,POP=THIRD PERIOD, AGEDESC=LT65);

*65-74 YEARS*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=FIRST PERIOD, AGEDESC=BW65_74);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=SECOND PERIOD, AGEDESC=BW65_74);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND (AGE_INT GE 65 AND AGE_INT LT 75),POP=THIRD PERIOD, AGEDESC=BW65_74);

*75+*;
%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE . AND AGE_INT GE 75,POP=FIRST PERIOD, AGEDESC=GE75);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE . AND AGE_INT GE 75,POP=SECOND PERIOD, AGEDESC=GE75);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE . AND AGE_INT GE 75,POP=THIRD PERIOD, AGEDESC=GE75); 


ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED DIFFERENTIALLY BY SSN, STRAT FU AND BL AGE - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION STRATIFIED BY FOLLOW UP TIME AND TIME AT BL, CENSORED DIFFERENTIALLY BY SSN';

TITLE2 'FIRST PERIOD, LESS THAN 65'; PROC PRINT DATA=FIRST_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, LESS THAN 65'; PROC PRINT DATA=SECOND_LT65_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_LT65_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, LESS THAN 65'; PROC PRINT DATA=THIRD_LT65_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_LT65_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 65-74'; PROC PRINT DATA=FIRST_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 65-74'; PROC PRINT DATA=SECOND_BW65_74_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 65-74'; PROC PRINT DATA=THIRD_BW65_74_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_BW65_74_NEW; VAR ClassVal0 RR CI; RUN;

TITLE2 'FIRST PERIOD, 75+'; PROC PRINT DATA=FIRST_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD, 75+'; PROC PRINT DATA=SECOND_GE75_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_GE75_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD, 75+'; PROC PRINT DATA=THIRD_GE75_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=THIRD_GE75_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*STRATIFIED BY FOLLOW UP PERIOD ONLY (NOT STRATIFIED BY AGE)*;

%COX_NEW (DATSET=FIRST,FT=FAIL1B_MO,CSOR=CORE1B,COND=FAIL1B_MO NE .,POP=FIRST PERIOD, AGEDESC=ALLAGES);
%COX_NEW (DATSET=SECOND,FT=FAIL2B_MO,CSOR=CORE2B,COND=FAIL2B_MO NE .,POP=SECOND PERIOD, AGEDESC=ALLAGES);
%COX_NEW (DATSET=THIRD,FT=FAIL3B_MO,CSOR=CORE3B,COND=FAIL3B_MO NE .,POP=THIRD PERIOD, AGEDESC=ALLAGES);

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED DIFFERENTIALLY BY SSN - STRAT FU TIME ONLY, RIGHT COLUMN - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION STRATIFIED BY FOLLOW UP TIME ONLY, CENSORED DIFFERENTIALLY BY SSN';

TITLE2 'FIRST PERIOD'; PROC PRINT DATA=FIRST_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=FIRST_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'SECOND PERIOD'; PROC PRINT DATA=SECOND_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=SECOND_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;
TITLE2 'THIRD PERIOD'; PROC PRINT DATA=THIRD_ALLAGES_FREQN; VAR BSINDEX FREQ; RUN;  PROC PRINT DATA=THIRD_ALLAGES_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;

PROC PHREG DATA=SPLITSSN MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=ALL_CENSSSN;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL FAILNEW_MO*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
            STRATA AGE_INT;
            TITLE2 'ENTIRE POPULATION, CENSORED DIFFERENTIALLY BY SSN';      
RUN;
ODS OUTPUT CLOSE;

DATA ALL_CENSSSN_NEW;
SET ALL_CENSSSN;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	CI=CAT("(",LL,", ",UL,")");

RUN;

ODS OUTPUT CrossTabFreqs=SPLITSSN_FREQ;
PROC FREQ DATA=SPLITSSN;
     TABLES BSINDEX*ALLCAUSE/NOROW NOCOL NOPERCENT NOCUM;
RUN;
ODS OUTPUT CLOSE;

DATA SPLITSSN_FREQN;
SET SPLITSSN_FREQ;

IF ALLCAUSE=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED DIFFERENTIALLY BY SSN, NON STRAT - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION NOT STRATIFIED, CENSORED DIFFERENTIALLY BY SSN, BOTTOM RIGHT CORNER';
TITLE2;
PROC PRINT DATA=SPLITSSN_FREQN; VAR BSINDEX FREQ; RUN; PROC PRINT DATA=ALL_CENSSSN_NEW; VAR ClassVal0 RR CI; RUN;

ODS RTF CLOSE;


*TABLES BOTTOM RIGHT HAND CORNER (NOT STRATIFIED ON FU TIME OR AGE AT BASELINE). MEN, WOMEN AND THEN COMBINED AMONG POPULATION WITHOUT CENSORING, BOTH CENSORED
AT 90, AND MALES CENSORED AT 90 AND FEMALES CENSORED AT 95*;

*NO CENSORING ON ATTAINED AGE*;
*ENTIRE POPULATION*;
PROC PHREG DATA=SOCIAL.FINALCOHORT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=NOCENSOR;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 SEX BLACK/RL;
            STRATA AGE_INT;
            TITLE2 'ENTIRE POPULATION, NOT CENSORED ON ATTAINED AGE';      
RUN;
ODS OUTPUT CLOSE;

DATA NOCENSOR_NEW;
SET NOCENSOR;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	RRCI=CAT(RR," (",LL,", ",UL,")");

RUN;

ODS OUTPUT CrossTabFreqs=NOCENSOR_FREQ;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
     TABLES BSINDEX*ALLCAUSE/NOROW NOCOL NOPERCENT NOCUM;
RUN;
ODS OUTPUT CLOSE;

DATA NOCENSOR_FREQN;
SET NOCENSOR_FREQ;

IF ALLCAUSE=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;

*WOMEN ONLY*;
PROC PHREG DATA=SOCIAL.FINALCOHORT MULTIPASS;
	ODS OUTPUT PARAMETERESTIMATES=NOCENSOR;
      CLASS BSINDEX SMOKENEW EDUNEW BMI (REF='2: 18.5-<25')/PARAM=REF REF=FIRST ORDER=INTERNAL;
      MODEL MONTH*ALLCAUSE(0)=BSINDEX SMOKENEW EDUNEW BMI DB82 BLACK/RL;
	  		WHERE SEX=1;
            STRATA AGE_INT;
            TITLE2 'ENTIRE POPULATION, NOT CENSORED ON ATTAINED AGE';      
RUN;
ODS OUTPUT CLOSE;

DATA NOCENSOR_NEW;
SET NOCENSOR;

IF PARAMETER IN ("BSINDEX");

	RR=PUT(ROUND(HAZARDRATIO,0.01),4.2);
	LL=PUT(ROUND(HRLOWERCL,0.01),4.2);
	UL=PUT(ROUND(HRUPPERCL,0.01),4.2);
	RRCI=CAT(RR," (",LL,", ",UL,")");
	

RUN;

ODS OUTPUT CrossTabFreqs=NOCENSOR_FREQ;
PROC FREQ DATA=SOCIAL.FINALCOHORT;
     TABLES BSINDEX*ALLCAUSE/NOROW NOCOL NOPERCENT NOCUM;
RUN;
ODS OUTPUT CLOSE;

DATA NOCENSOR_FREQN;
SET NOCENSOR_FREQ;

IF ALLCAUSE=1;
FREQ=PUT(FREQUENCY, COMMA7.);

RUN;

*USING CHRISSY'S MACRO*;
%INCLUDE 'D:\USER\CCLEMENTS\MACROS\SURVMODS.sas';
OPTIONS MPRINT;

*TOTAL POPULATION, NO CENSORING*;
%SURVMODS(DATASET=SOCIAL.FINALCOHORT,FAIL=MONTH,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 SEX BLACK, STRAT=, STRATLBL=, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

*WOMEN, NO CENSORING*;
%SURVMODS(DATASET=SOCIAL.FINALCOHORT,FAIL=MONTH,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 BLACK, STRAT=SEX=1, STRATLBL=WOMEN, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

*MEN, NO CENSORING*;
%SURVMODS(DATASET=SOCIAL.FINALCOHORT,FAIL=MONTH,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 BLACK, STRAT=SEX=0, STRATLBL=MEN, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\NO CENSORING, NON-STRATIFIED MODELS - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION, NO CENSORING'; PROC PRINT DATA=ALLCAUSE_BSINDEX; VAR EXPLBL CASEPYR MVHRCI; RUN;
TITLE 'WOMEN, NO CENSORING'; PROC PRINT DATA=ALLCAUSE_BSINDEX_WOMEN; VAR EXPLBL CASEPYR MVHRCI; RUN;
TITLE 'MEN, NO CENSORING'; PROC PRINT DATA=ALLCAUSE_BSINDEX_MEN; VAR EXPLBL CASEPYR MVHRCI; RUN;

ODS RTF CLOSE;

*CENSORED AT 90*;
DATA SPLIT90;
SET SOCIAL.FINALCOHORT;

*CODE FOR CENSORING AT 90*;
IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+32872.5));
ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+32872.5));

FAILNEW=DATEFU-BEGDATE;
FAILNEW_MO=(FAILNEW/365.25 + 1/365.25)*12;
IF DATEFU<DTHDATE THEN ALLCAUSE=0; *IF SOMEONE TURNED 90 BEFORE THEY DIED, SETTING DEATH TO 0*;

RUN;


*TOTAL POPULATION, CENSORED AT 90*;
%SURVMODS(DATASET=SPLIT90,FAIL=FAILNEW_MO,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 SEX BLACK, STRAT=, STRATLBL=, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

*WOMEN, CENSORED AT 90*;
%SURVMODS(DATASET=SPLIT90,FAIL=FAILNEW_MO,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 BLACK, STRAT=SEX=1, STRATLBL=WOMEN, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

*MEN, CENSORED AT 90*;
%SURVMODS(DATASET=SPLIT90,FAIL=FAILNEW_MO,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 BLACK, STRAT=SEX=0, STRATLBL=MEN, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED AT 90, NON-STRATIFIED MODELS - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION, CENSORED AT 90'; PROC PRINT DATA=ALLCAUSE_BSINDEX; VAR EXPLBL CASEPYR MVHRCI; RUN;
TITLE 'WOMEN, CENSORED AT 90'; PROC PRINT DATA=ALLCAUSE_BSINDEX_WOMEN; VAR EXPLBL CASEPYR MVHRCI; RUN;
TITLE 'MEN, CENSORED AT 90'; PROC PRINT DATA=ALLCAUSE_BSINDEX_MEN; VAR EXPLBL CASEPYR MVHRCI; RUN;

ODS RTF CLOSE;


*CENSORED AT 90 FOR MEN AND 95 FOR WOMEN*;
DATA SPLIT9095;
SET SOCIAL.FINALCOHORT;

*CODE FOR CENSORING AT 90*;
IF SEX=0 THEN DO; *MEN*;
IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+32872.5));
ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+32872.5));
END;

IF SEX=1 THEN DO; *WOMEN*;
IF DTHDATE NE . THEN DATEFU=MIN(DTHDATE, ENDFU, (BDAYDATE+34698.75));
ELSE IF DTHDATE=. THEN DATEFU=MIN(ENDFU, (BDAYDATE+34698.75));
END;

FAILNEW=DATEFU-BEGDATE;
FAILNEW_MO=(FAILNEW/365.25 + 1/365.25)*12;
IF DATEFU<DTHDATE THEN ALLCAUSE=0; *IF SOMEONE TURNED 90 BEFORE THEY DIED, SETTING DEATH TO 0*;

RUN;

*TOTAL POPULATION, CENSORED AT 90*;
%SURVMODS(DATASET=SPLIT9095,FAIL=FAILNEW_MO,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 SEX BLACK, STRAT=, STRATLBL=, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

*WOMEN, CENSORED AT 90*;
%SURVMODS(DATASET=SPLIT9095,FAIL=FAILNEW_MO,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 BLACK, STRAT=SEX=1, STRATLBL=WOMEN, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

*MEN, CENSORED AT 90*;
%SURVMODS(DATASET=SPLIT9095,FAIL=FAILNEW_MO,CASE=ALLCAUSE,EXP=BSINDEX,REF=0,CONTEXP=, COV=SMOKENEW EDUNEW BMI DB82 BLACK, STRAT=SEX=0, STRATLBL=MEN, AA=0,
STRATA=AGE_INT, ACROSS= , TOTAL= )  

ODS RTF FILE="D:\USER\JBLASE\Social Support\OUTPUT\NEW TABLES\CENSORED DIFFERENTIALLY BY SEX, NON-STRATIFIED MODELS - &SYSDATE..RTF";

TITLE 'ENTIRE POPULATION, MEN CENSORED AT 90, WOMEN CENSORED AT 95'; PROC PRINT DATA=ALLCAUSE_BSINDEX; VAR EXPLBL CASEPYR MVHRCI; RUN;
TITLE 'WOMEN ONLY, CENSORED AT 95'; PROC PRINT DATA=ALLCAUSE_BSINDEX_WOMEN; VAR EXPLBL CASEPYR MVHRCI; RUN;
TITLE 'MEN ONLY, CENSORED AT 90'; PROC PRINT DATA=ALLCAUSE_BSINDEX_MEN; VAR EXPLBL CASEPYR MVHRCI; RUN;

ODS RTF CLOSE;
